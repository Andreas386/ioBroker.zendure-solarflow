{
  "version": 3,
  "sources": ["../../src/services/calculationService.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/indent */\r\n\r\nimport { ZendureSolarflow } from \"../main\";\r\nimport { ISolarFlowDeviceDetails } from \"../models/ISolarFlowDeviceDetails\";\r\n\r\nconst calculationStateKeys = [\r\n  \"packInput\",\r\n  \"outputHome\",\r\n  \"outputPack\",\r\n  \"solarInput\",\r\n];\r\n\r\nexport const setEnergyWhMax = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n): Promise<void> => {\r\n  const currentEnergyState = await adapter?.getStateAsync(\r\n    productKey + \".\" + deviceKey + \".calculations.energyWh\",\r\n  );\r\n\r\n  if (currentEnergyState) {\r\n    await adapter?.setStateAsync(\r\n      `${productKey}.${deviceKey}.calculations.energyWhMax`,\r\n      currentEnergyState?.val,\r\n      true,\r\n    );\r\n  }\r\n}\r\n\r\nexport const calculateSocAndEnergy = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n  stateKey: string,\r\n  value: number,\r\n): Promise<void> => {\r\n  const currentEnergyState = await adapter?.getStateAsync(\r\n    productKey + \".\" + deviceKey + \".calculations.energyWh\",\r\n  );\r\n\r\n  const currentEnergyMaxState = await adapter?.getStateAsync(\r\n    productKey + \".\" + deviceKey + \".calculations.energyWhMax\",\r\n  );\r\n\r\n  const currentValue = currentEnergyState?.val\r\n    ? Number(currentEnergyState?.val)\r\n    : 0;\r\n\r\n  const newValue =\r\n    stateKey == \"outputPack\" ? currentValue + value : currentValue - value;\r\n\r\n  if (newValue > 0) {\r\n    adapter?.setState(\r\n      `${productKey}.${deviceKey}.calculations.energyWh`,\r\n      newValue,\r\n      true,\r\n    );\r\n\r\n    if (currentEnergyMaxState) {\r\n      const soc = Number(((newValue / Number(currentEnergyMaxState.val)) * 100).toFixed(1));\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.soc`,\r\n        soc,\r\n        true,\r\n      );\r\n\r\n      if (newValue > Number(currentEnergyMaxState.val)) {\r\n        // Extend maxVal\r\n        await adapter?.setStateAsync(\r\n          `${productKey}.${deviceKey}.calculations.energyWhMax`,\r\n          newValue,\r\n          true,\r\n        );\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nexport const calculateEnergy = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n): Promise<void> => {\r\n  calculationStateKeys.forEach(async (stateKey) => {\r\n    const stateNameEnergyWh = `${productKey}.${deviceKey}.calculations.${stateKey}EnergyTodayWh`;\r\n    const stateNameEnergykWh = `${productKey}.${deviceKey}.calculations.${stateKey}EnergyTodaykWh`;\r\n    const stateNamePower = `${productKey}.${deviceKey}.${stateKey}Power`;\r\n\r\n    const currentPowerState = await adapter?.getStateAsync(stateNamePower);\r\n    const currentEnergyState = await adapter?.getStateAsync(stateNameEnergyWh);\r\n\r\n    if (currentEnergyState?.val == 0) {\r\n      // Workaround, set Val to very low value to avoid Jump in data...\r\n      await adapter?.setStateAsync(stateNameEnergyWh, 0.000001, true);\r\n    } else if (\r\n      currentEnergyState &&\r\n      currentEnergyState.lc &&\r\n      currentPowerState &&\r\n      currentPowerState.val != undefined &&\r\n      currentPowerState.val != null\r\n    ) {\r\n      // Timeframe = 30000ms, Job runs every 30 seconds...\r\n      const timeFrame = 30000;\r\n\r\n      const addValue = (Number(currentPowerState.val) * timeFrame) / 3600000; // Wh\r\n      let newValue = Number(currentEnergyState.val) + addValue;\r\n\r\n      // Fix negative value\r\n      if (newValue < 0) {\r\n        newValue = 0;\r\n      }\r\n\r\n      const chargingFactor = 0.96; // Efficiency 96%\r\n      const dischargingFactor = 1.08 - (newValue / 10000); // Efficiency 92% - 98% (92% + Energy / 10000 = 600W -> + 0.06%)\r\n\r\n      newValue = stateKey == \"outputPack\" && newValue > 0 ? newValue * chargingFactor : newValue;\r\n      newValue = stateKey == \"packInput\" && newValue > 0 ? newValue * dischargingFactor : newValue;\r\n\r\n      await adapter?.setStateAsync(stateNameEnergyWh, newValue, true);\r\n      await adapter?.setStateAsync(\r\n        stateNameEnergykWh,\r\n        Number((newValue / 1000).toFixed(2)),\r\n        true,\r\n      );\r\n\r\n      // SOC and energy in batteries\r\n      if ((stateKey == \"outputPack\" || stateKey == \"packInput\") && addValue > 0) {\r\n        await calculateSocAndEnergy(\r\n          adapter,\r\n          productKey,\r\n          deviceKey,\r\n          stateKey,\r\n          addValue,\r\n        );\r\n      }\r\n    } else {\r\n      await adapter?.setStateAsync(stateNameEnergyWh, 0, true);\r\n      await adapter?.setStateAsync(stateNameEnergykWh, 0, true);\r\n    }\r\n  });\r\n};\r\n\r\nexport const resetTodaysValues = async (\r\n  adapter: ZendureSolarflow,\r\n): Promise<void> => {\r\n  adapter.deviceList.forEach((device: ISolarFlowDeviceDetails) => {\r\n    calculationStateKeys.forEach(async (stateKey: string) => {\r\n      const stateNameEnergyWh = `${device.productKey}.${device.deviceKey}.calculations.${stateKey}EnergyTodayWh`;\r\n      const stateNameEnergykWh = `${device.productKey}.${device.deviceKey}.calculations.${stateKey}EnergyTodaykWh`;\r\n\r\n      await adapter?.setStateAsync(stateNameEnergyWh, 0, true);\r\n      await adapter?.setStateAsync(stateNameEnergykWh, 0, true);\r\n    });\r\n  });\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
