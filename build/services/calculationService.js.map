{
  "version": 3,
  "sources": ["../../src/services/calculationService.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/indent */\r\n\r\nimport { ZendureSolarflow } from \"../main\";\r\nimport { ISolarFlowDeviceDetails } from \"../models/ISolarFlowDeviceDetails\";\r\n\r\nconst calculationStateKeys = [\r\n  \"packInput\",\r\n  \"outputHome\",\r\n  \"outputPack\",\r\n  \"solarInput\",\r\n];\r\n\r\nexport const calculateSocAndEnergy = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n  stateKey: string,\r\n  value: number,\r\n): Promise<void> => {\r\n  const currentEnergyState = await adapter?.getStateAsync(\r\n    productKey + \".\" + deviceKey + \".calculations.energyWh\",\r\n  );\r\n\r\n  const currentEnergyMaxState = await adapter?.getStateAsync(\r\n    productKey + \".\" + deviceKey + \".calculations.energyWhMax\",\r\n  );\r\n\r\n  const currentValue = currentEnergyState?.val\r\n    ? Number(currentEnergyState?.val)\r\n    : 0;\r\n\r\n  const newValue =\r\n    stateKey == \"outputPack\" ? currentValue + value : currentValue - value;\r\n\r\n  if (newValue > 0) {\r\n    adapter?.setStateAsync(\r\n      `${productKey}.${deviceKey}.calculations.energyWh`,\r\n      newValue,\r\n      true,\r\n    );\r\n\r\n    if (currentEnergyMaxState) {\r\n      const soc = (newValue / Number(currentEnergyMaxState.val)) * 100;\r\n      adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.soc`,\r\n        soc,\r\n        true,\r\n      );\r\n\r\n      if (newValue > Number(currentEnergyMaxState.val)) {\r\n        // Extend maxVal\r\n        adapter?.setStateAsync(\r\n          `${productKey}.${deviceKey}.calculations.energyWhMax`,\r\n          newValue,\r\n          true,\r\n        );\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nexport const calculateEnergy = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n): Promise<void> => {\r\n  calculationStateKeys.forEach(async (stateKey) => {\r\n    const stateNameEnergyWh = `${productKey}.${deviceKey}.calculations.${stateKey}EnergyTodayWh`;\r\n    const stateNameEnergykWh = `${productKey}.${deviceKey}.calculations.${stateKey}EnergyTodaykWh`;\r\n    const stateNamePower = `${productKey}.${deviceKey}.${stateKey}Power`;\r\n\r\n    const currentPowerState = await adapter?.getStateAsync(stateNamePower);\r\n    const currentEnergyState = await adapter?.getStateAsync(stateNameEnergyWh);\r\n\r\n    if (currentEnergyState?.val == 0) {\r\n      // Workaround, set Val to very low value to avoid Jump in data...\r\n      adapter?.setStateAsync(stateNameEnergyWh, 0.000001, true);\r\n    } else if (\r\n      currentEnergyState &&\r\n      currentEnergyState.lc &&\r\n      currentPowerState &&\r\n      currentPowerState.val != undefined &&\r\n      currentPowerState.val != null\r\n    ) {\r\n      const timeFrame = currentPowerState.lc - currentEnergyState?.lc;\r\n\r\n      const addValue = (Number(currentPowerState.val) * timeFrame) / 3600000; // Wh\r\n      const newValue = Number(currentEnergyState.val) + addValue;\r\n\r\n      adapter?.setStateAsync(stateNameEnergyWh, newValue, true);\r\n      adapter?.setStateAsync(\r\n        stateNameEnergykWh,\r\n        Number((newValue / 1000).toFixed(2)),\r\n        true,\r\n      );\r\n\r\n      // SOC and energy in batteries\r\n      if (stateKey == \"outputPack\" || stateKey == \"packInput\") {\r\n        calculateSocAndEnergy(\r\n          adapter,\r\n          productKey,\r\n          deviceKey,\r\n          stateKey,\r\n          addValue,\r\n        );\r\n      }\r\n    } else {\r\n      adapter?.setStateAsync(stateNameEnergyWh, 0, true);\r\n      adapter?.setStateAsync(stateNameEnergykWh, 0, true);\r\n    }\r\n  });\r\n};\r\n\r\nexport const resetTodaysValues = async (\r\n  adapter: ZendureSolarflow,\r\n): Promise<void> => {\r\n  adapter.deviceList.forEach((device: ISolarFlowDeviceDetails) => {\r\n    calculationStateKeys.forEach((stateKey: string) => {\r\n      const stateNameEnergyWh = `${device.productKey}.${device.deviceKey}.calculations.${stateKey}EnergyTodayWh`;\r\n      const stateNameEnergykWh = `${device.productKey}.${device.deviceKey}.calculations.${stateKey}EnergyTodaykWh`;\r\n\r\n      adapter?.setStateAsync(stateNameEnergyWh, 0, true);\r\n      adapter?.setStateAsync(stateNameEnergykWh, 0, true);\r\n    });\r\n  });\r\n};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA,MAAM,uBAAuB;AAAA,EAC3B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEO,MAAM,wBAAwB,OACnC,SACA,YACA,WACA,UACA,UACkB;AAClB,QAAM,qBAAqB,OAAM,mCAAS;AAAA,IACxC,aAAa,MAAM,YAAY;AAAA;AAGjC,QAAM,wBAAwB,OAAM,mCAAS;AAAA,IAC3C,aAAa,MAAM,YAAY;AAAA;AAGjC,QAAM,gBAAe,yDAAoB,OACrC,OAAO,yDAAoB,GAAG,IAC9B;AAEJ,QAAM,WACJ,YAAY,eAAe,eAAe,QAAQ,eAAe;AAEnE,MAAI,WAAW,GAAG;AAChB,uCAAS;AAAA,MACP,GAAG,UAAU,IAAI,SAAS;AAAA,MAC1B;AAAA,MACA;AAAA;AAGF,QAAI,uBAAuB;AACzB,YAAM,MAAO,WAAW,OAAO,sBAAsB,GAAG,IAAK;AAC7D,yCAAS;AAAA,QACP,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAGF,UAAI,WAAW,OAAO,sBAAsB,GAAG,GAAG;AAEhD,2CAAS;AAAA,UACP,GAAG,UAAU,IAAI,SAAS;AAAA,UAC1B;AAAA,UACA;AAAA;AAAA,MAEJ;AAAA,IACF;AAAA,EACF;AACF;AAEO,MAAM,kBAAkB,OAC7B,SACA,YACA,cACkB;AAClB,uBAAqB,QAAQ,OAAO,aAAa;AAC/C,UAAM,oBAAoB,GAAG,UAAU,IAAI,SAAS,iBAAiB,QAAQ;AAC7E,UAAM,qBAAqB,GAAG,UAAU,IAAI,SAAS,iBAAiB,QAAQ;AAC9E,UAAM,iBAAiB,GAAG,UAAU,IAAI,SAAS,IAAI,QAAQ;AAE7D,UAAM,oBAAoB,OAAM,mCAAS,cAAc;AACvD,UAAM,qBAAqB,OAAM,mCAAS,cAAc;AAExD,SAAI,yDAAoB,QAAO,GAAG;AAEhC,yCAAS,cAAc,mBAAmB,MAAU;AAAA,IACtD,WACE,sBACA,mBAAmB,MACnB,qBACA,kBAAkB,OAAO,UACzB,kBAAkB,OAAO,MACzB;AACA,YAAM,YAAY,kBAAkB,MAAK,yDAAoB;AAE7D,YAAM,WAAY,OAAO,kBAAkB,GAAG,IAAI,YAAa;AAC/D,YAAM,WAAW,OAAO,mBAAmB,GAAG,IAAI;AAElD,yCAAS,cAAc,mBAAmB,UAAU;AACpD,yCAAS;AAAA,QACP;AAAA,QACA,QAAQ,WAAW,KAAM,QAAQ,CAAC,CAAC;AAAA,QACnC;AAAA;AAIF,UAAI,YAAY,gBAAgB,YAAY,aAAa;AACvD;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAAA,MACF;AAAA,IACF,OAAO;AACL,yCAAS,cAAc,mBAAmB,GAAG;AAC7C,yCAAS,cAAc,oBAAoB,GAAG;AAAA,IAChD;AAAA,EACF,CAAC;AACH;AAEO,MAAM,oBAAoB,OAC/B,YACkB;AAClB,UAAQ,WAAW,QAAQ,CAAC,WAAoC;AAC9D,yBAAqB,QAAQ,CAAC,aAAqB;AACjD,YAAM,oBAAoB,GAAG,OAAO,UAAU,IAAI,OAAO,SAAS,iBAAiB,QAAQ;AAC3F,YAAM,qBAAqB,GAAG,OAAO,UAAU,IAAI,OAAO,SAAS,iBAAiB,QAAQ;AAE5F,yCAAS,cAAc,mBAAmB,GAAG;AAC7C,yCAAS,cAAc,oBAAoB,GAAG;AAAA,IAChD,CAAC;AAAA,EACH,CAAC;AACH;",
  "names": []
}
