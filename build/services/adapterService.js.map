{
  "version": 3,
  "sources": ["../../src/services/adapterService.ts"],
  "sourcesContent": ["import { ZendureSolarflow } from \"../main\";\r\nimport { setOutputLimit } from \"./mqttService\";\r\n\r\n/* eslint-disable @typescript-eslint/indent */\r\n\r\nexport const updateSolarFlowState = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n  state: string,\r\n  val: number | string | boolean,\r\n): Promise<void> => {\r\n  await adapter?.setStateAsync(`${productKey}.${deviceKey}.${state}`, val, true);\r\n};\r\n\r\nexport const checkVoltage = async (\r\n  adapter: ZendureSolarflow,\r\n  productKey: string,\r\n  deviceKey: string,\r\n  voltage: number,\r\n): Promise<void> => {\r\n  if (voltage < 46.1) {\r\n    if (adapter.config.useCalculation) {\r\n      // Set SOC to 0\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.soc`,\r\n        0,\r\n        true,\r\n      );\r\n\r\n      // Calculate new Wh Max Value\r\n      const energyWhState = await adapter.getStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.energyWh`,\r\n      );\r\n      const energyWhMaxState = await adapter.getStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.energyWhMax`,\r\n      );\r\n\r\n      const newMax = Number(energyWhMaxState?.val) - Number(energyWhState?.val);\r\n\r\n      // Set Max Energy to value minus current energy\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.energyWhMax`,\r\n        newMax,\r\n        true,\r\n      );\r\n\r\n      // Set Energy in Battery to 0\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.calculations.energyWh`,\r\n        0,\r\n        true,\r\n      );\r\n    }\r\n\r\n    if (adapter.config.useLowVoltageBlock) {\r\n      // Activate Low Voltage Block\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.control.lowVoltageBlock`,\r\n        true,\r\n        true,\r\n      );\r\n\r\n      // Low Voltage Block activated, stop power input immediately\r\n      setOutputLimit(adapter, productKey, deviceKey, 0);\r\n    }\r\n  } else if (voltage >= 48.0) {\r\n    if (adapter.config.useLowVoltageBlock) {\r\n      // Deactivate Low Voltage Block\r\n      await adapter?.setStateAsync(\r\n        `${productKey}.${deviceKey}.control.lowVoltageBlock`,\r\n        false,\r\n        true,\r\n      );\r\n    }\r\n  }\r\n};\r\n\r\nexport const checkDevicesServer = async (adapter: ZendureSolarflow): Promise<void> => {\r\n  const channels = await adapter.getChannelsAsync();\r\n\r\n  channels.forEach(async (channel) => {\r\n    if (channel._id) {\r\n      const splitted = channel._id.split(\".\");\r\n      if (splitted.length == 4) {\r\n        const productKey = splitted[2];\r\n        const deviceKey = splitted[3];\r\n\r\n        const currentServerState = await adapter.getStateAsync(\r\n          `${productKey}.${deviceKey}.registeredServer`,\r\n        );\r\n\r\n        if (\r\n          currentServerState &&\r\n          currentServerState.val &&\r\n          currentServerState.val != adapter.config.server\r\n        ) {\r\n          adapter.log.warn(\r\n            `Device with ProductKey '${productKey}' and DeviceKey '${deviceKey}' was configured on server '${currentServerState.val}', but adapter is configured to use server '${adapter.config.server}'! No data will be available!`,\r\n          );\r\n        }\r\n      }\r\n    }\r\n  });\r\n};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAA+B;AAIxB,MAAM,uBAAuB,OAClC,SACA,YACA,WACA,OACA,QACkB;AAClB,SAAM,mCAAS,cAAc,GAAG,UAAU,IAAI,SAAS,IAAI,KAAK,IAAI,KAAK;AAC3E;AAEO,MAAM,eAAe,OAC1B,SACA,YACA,WACA,YACkB;AAClB,MAAI,UAAU,MAAM;AAClB,QAAI,QAAQ,OAAO,gBAAgB;AAEjC,aAAM,mCAAS;AAAA,QACb,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAIF,YAAM,gBAAgB,MAAM,QAAQ;AAAA,QAClC,GAAG,UAAU,IAAI,SAAS;AAAA,MAC5B;AACA,YAAM,mBAAmB,MAAM,QAAQ;AAAA,QACrC,GAAG,UAAU,IAAI,SAAS;AAAA,MAC5B;AAEA,YAAM,SAAS,OAAO,qDAAkB,GAAG,IAAI,OAAO,+CAAe,GAAG;AAGxE,aAAM,mCAAS;AAAA,QACb,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAIF,aAAM,mCAAS;AAAA,QACb,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAAA,IAEJ;AAEA,QAAI,QAAQ,OAAO,oBAAoB;AAErC,aAAM,mCAAS;AAAA,QACb,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAIF,6CAAe,SAAS,YAAY,WAAW,CAAC;AAAA,IAClD;AAAA,EACF,WAAW,WAAW,IAAM;AAC1B,QAAI,QAAQ,OAAO,oBAAoB;AAErC,aAAM,mCAAS;AAAA,QACb,GAAG,UAAU,IAAI,SAAS;AAAA,QAC1B;AAAA,QACA;AAAA;AAAA,IAEJ;AAAA,EACF;AACF;AAEO,MAAM,qBAAqB,OAAO,YAA6C;AACpF,QAAM,WAAW,MAAM,QAAQ,iBAAiB;AAEhD,WAAS,QAAQ,OAAO,YAAY;AAClC,QAAI,QAAQ,KAAK;AACf,YAAM,WAAW,QAAQ,IAAI,MAAM,GAAG;AACtC,UAAI,SAAS,UAAU,GAAG;AACxB,cAAM,aAAa,SAAS,CAAC;AAC7B,cAAM,YAAY,SAAS,CAAC;AAE5B,cAAM,qBAAqB,MAAM,QAAQ;AAAA,UACvC,GAAG,UAAU,IAAI,SAAS;AAAA,QAC5B;AAEA,YACE,sBACA,mBAAmB,OACnB,mBAAmB,OAAO,QAAQ,OAAO,QACzC;AACA,kBAAQ,IAAI;AAAA,YACV,2BAA2B,UAAU,oBAAoB,SAAS,+BAA+B,mBAAmB,GAAG,+CAA+C,QAAQ,OAAO,MAAM;AAAA,UAC7L;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,EACF,CAAC;AACH;",
  "names": []
}
