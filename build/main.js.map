{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/indent */\r\n/*\r\n * Created with @iobroker/create-adapter v2.5.0\r\n */\r\n\r\n// The adapter-core module gives you access to the core ioBroker functions\r\n// you need to create an adapter\r\nimport * as utils from \"@iobroker/adapter-core\";\r\nimport {\r\n  connectMqttClient,\r\n  setChargeLimit,\r\n  setDischargeLimit,\r\n  setOutputLimit,\r\n} from \"./services/mqttService\";\r\nimport { getDeviceList, login } from \"./services/webService\";\r\nimport { ISolarFlowDeviceDetails } from \"./models/ISolarFlowDeviceDetails\";\r\nimport { ISolarFlowPaths } from \"./models/ISolarFlowPaths\";\r\nimport { pathsGlobal } from \"./constants/paths\";\r\nimport {\r\n  calculateEnergy,\r\n  resetTodaysValues,\r\n  startCheckStatesTimer,\r\n} from \"./services/adapterService\";\r\nimport { Job, scheduleJob } from \"node-schedule\";\r\n\r\nexport class ZendureSolarflow extends utils.Adapter {\r\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n    super({\r\n      ...options,\r\n      name: \"zendure-solarflow\",\r\n    });\r\n    this.on(\"ready\", this.onReady.bind(this));\r\n    this.on(\"stateChange\", this.onStateChange.bind(this));\r\n    this.on(\"unload\", this.onUnload.bind(this));\r\n  }\r\n\r\n  public accessToken: string | undefined = undefined; // Access Token for Zendure Rest API\r\n  public deviceList: ISolarFlowDeviceDetails[] = [];\r\n  public paths: ISolarFlowPaths | undefined = undefined;\r\n  public interval: ioBroker.Interval | undefined = undefined;\r\n  public lastLogin: Date | undefined = undefined;\r\n\r\n  public resetValuesJob: Job | undefined = undefined;\r\n\r\n  /**\r\n   * Is called when databases are connected and adapter received configuration.\r\n   */\r\n  private async onReady(): Promise<void> {\r\n    // Currently only global Zendure Server are supported!\r\n    this.paths = pathsGlobal;\r\n\r\n    // If Username and Password is provided, try to login and get the access token.\r\n    if (this.config.userName && this.config.password) {\r\n      login(this)\r\n        ?.then((_accessToken: string) => {\r\n          this.accessToken = _accessToken;\r\n\r\n          this.connected = true;\r\n          this.lastLogin = new Date();\r\n\r\n          // Schedule Job\r\n          this.resetValuesJob = scheduleJob(\"0 0 * * *\", () => {\r\n            // Relogin at night to get a fresh accessToken!\r\n            this.log.debug(`Refreshing accessToken!`);\r\n\r\n            if (this.config.userName && this.config.password) {\r\n              login(this)?.then((_accessToken: string) => {\r\n                this.accessToken = _accessToken;\r\n                this.lastLogin = new Date();\r\n                this.connected = true;\r\n              });\r\n            }\r\n\r\n            // Reset Values\r\n            resetTodaysValues(this);\r\n          });\r\n\r\n          // Try to get the device list\r\n          getDeviceList(this)\r\n            .then((result: ISolarFlowDeviceDetails[]) => {\r\n              if (result) {\r\n                // Device List found. Save in the adapter properties and connect to MQTT\r\n                this.deviceList = result;\r\n                connectMqttClient(this);\r\n                startCheckStatesTimer(this);\r\n              }\r\n            })\r\n            .catch(() => {\r\n              this.connected = false;\r\n              this.log?.error(\"Retrieving device failed!\");\r\n            });\r\n        })\r\n        .catch((error) => {\r\n          this.connected = false;\r\n          this.log.error(\r\n            \"Logon error at Zendure cloud service! Error: \" + error.toString(),\r\n          );\r\n        });\r\n    } else {\r\n      this.connected = false;\r\n      this.log.error(\"No Login Information provided!\");\r\n      //this.stop?.();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n   */\r\n  private onUnload(callback: () => void): void {\r\n    try {\r\n      if (this.interval) {\r\n        this.clearInterval(this.interval);\r\n      }\r\n\r\n      // Scheduler beenden\r\n      if (this.resetValuesJob) {\r\n        this.resetValuesJob.cancel();\r\n      }\r\n\r\n      callback();\r\n    } catch (e) {\r\n      callback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called if a subscribed state changes\r\n   */\r\n  private onStateChange(\r\n    id: string,\r\n    state: ioBroker.State | null | undefined,\r\n  ): void {\r\n    if (state) {\r\n      // The state was changed\r\n      //this.log.debug(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n\r\n      // Read product and device key from string\r\n      const splitted = id.split(\".\");\r\n      const productKey = splitted[2];\r\n      const deviceKey = splitted[3];\r\n\r\n      if (id.includes(\"setOutputLimit\") && state.val != undefined && state.val != null) {\r\n        setOutputLimit(this, productKey, deviceKey, Number(state.val));\r\n      } else if (id.includes(\"dischargeLimit\")&& state.val != undefined && state.val != null) {\r\n        setDischargeLimit(this, productKey, deviceKey, Number(state.val));\r\n      } else if (id.includes(\"chargeLimit\")&& state.val != undefined && state.val != null) {\r\n        setChargeLimit(this, productKey, deviceKey, Number(state.val));\r\n      } else if (id.includes(\"solarInput\")&& state.val != undefined && state.val != null) {\r\n        // Calculate todays solar input\r\n        calculateEnergy(this, productKey, deviceKey, \"solarInput\", state);\r\n      } else if (id.includes(\"outputPackPower\")&& state.val != undefined && state.val != null) {\r\n        // Calculate todays output pack power (energy to battery)\r\n        calculateEnergy(this, productKey, deviceKey, \"outputPack\", state);\r\n      } else if (id.includes(\"packInputPower\")&& state.val != undefined && state.val != null) {\r\n        // Calculate todays pack input power (energy from battery)\r\n        calculateEnergy(this, productKey, deviceKey, \"packInput\", state);\r\n      } else if (id.includes(\"outputHomePower\")&& state.val != undefined && state.val != null) {\r\n        // Calculate todays pack input power (energy from system to home)\r\n        calculateEnergy(this, productKey, deviceKey, \"outputHome\", state);\r\n      }\r\n    } else {\r\n      // The state was deleted\r\n      this.log.debug(`state ${id} deleted`);\r\n    }\r\n  }\r\n}\r\n\r\nif (require.main !== module) {\r\n  // Export the constructor in compact mode\r\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) =>\r\n    new ZendureSolarflow(options);\r\n} else {\r\n  // otherwise start the instance directly\r\n  (() => new ZendureSolarflow())();\r\n}\r\n"],
  "mappings": "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",
  "names": ["_a", "_accessToken"]
}
