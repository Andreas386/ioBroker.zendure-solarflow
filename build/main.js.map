{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/indent */\r\n/*\r\n * Created with @iobroker/create-adapter v2.5.0\r\n */\r\n\r\n// The adapter-core module gives you access to the core ioBroker functions\r\n// you need to create an adapter\r\nimport * as utils from \"@iobroker/adapter-core\";\r\nimport {\r\n  connectMqttClient,\r\n  setChargeLimit,\r\n  setDischargeLimit,\r\n  setOutputLimit,\r\n} from \"./services/mqttService\";\r\nimport { getDeviceList, login } from \"./services/webService\";\r\nimport { ISolarFlowDeviceDetails } from \"./models/ISolarFlowDeviceDetails\";\r\nimport { ISolarFlowPaths } from \"./models/ISolarFlowPaths\";\r\nimport { pathsEu, pathsGlobal } from \"./constants/paths\";\r\nimport { Job } from \"node-schedule\";\r\nimport {\r\n  startCalculationJob,\r\n  startCheckStatesJob,\r\n  startReloginAndResetValuesJob,\r\n} from \"./services/jobSchedule\";\r\nimport { MqttClient } from \"mqtt\";\r\n\r\nexport class ZendureSolarflow extends utils.Adapter {\r\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n    super({\r\n      ...options,\r\n      name: \"zendure-solarflow\",\r\n    });\r\n    this.on(\"ready\", this.onReady.bind(this));\r\n    this.on(\"stateChange\", this.onStateChange.bind(this));\r\n    this.on(\"unload\", this.onUnload.bind(this));\r\n  }\r\n\r\n  public accessToken: string | undefined = undefined; // Access Token for Zendure Rest API\r\n  public deviceList: ISolarFlowDeviceDetails[] = [];\r\n  public paths: ISolarFlowPaths | undefined = undefined;\r\n  public interval: ioBroker.Interval | undefined = undefined;\r\n  public lastLogin: Date | undefined = undefined;\r\n\r\n  public mqttClient: MqttClient | undefined = undefined;\r\n\r\n  public resetValuesJob: Job | undefined = undefined;\r\n  public checkStatesJob: Job | undefined = undefined;\r\n  public calculationJob: Job | undefined = undefined;\r\n\r\n  /**\r\n   * Is called when databases are connected and adapter received configuration.\r\n   */\r\n  private async onReady(): Promise<void> {\r\n    // Select paths by config value\r\n    if (this.config.server && this.config.server == \"eu\") {\r\n      this.paths = pathsEu;\r\n    } else {\r\n      this.paths = pathsGlobal;\r\n    }\r\n\r\n    // If Username and Password is provided, try to login and get the access token.\r\n    if (this.config.userName && this.config.password) {\r\n      login(this)\r\n        ?.then((_accessToken: string) => {\r\n          this.accessToken = _accessToken;\r\n\r\n          this.connected = true;\r\n          this.lastLogin = new Date();\r\n\r\n          // Try to get the device list\r\n          getDeviceList(this)\r\n            .then((result: ISolarFlowDeviceDetails[]) => {\r\n              if (result) {\r\n                // Device List found. Save in the adapter properties and connect to MQTT\r\n                this.deviceList = result;\r\n                connectMqttClient(this);\r\n\r\n                // Schedule Job\r\n                startReloginAndResetValuesJob(this);\r\n                startCheckStatesJob(this);\r\n                startCalculationJob(this);\r\n              }\r\n            })\r\n            .catch(() => {\r\n              this.connected = false;\r\n              this.log?.error(\"[onReady] Retrieving device failed!\");\r\n            });\r\n        })\r\n        .catch((error) => {\r\n          this.connected = false;\r\n          this.log.error(\r\n            \"[onReady] Logon error at Zendure cloud service! Error: \" +\r\n              error.toString(),\r\n          );\r\n        });\r\n    } else {\r\n      this.connected = false;\r\n      this.log.error(\"[onReady] No Login Information provided!\");\r\n      //this.stop?.();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n   */\r\n  private onUnload(callback: () => void): void {\r\n    try {\r\n      if (this.interval) {\r\n        this.clearInterval(this.interval);\r\n      }\r\n\r\n      // Scheduler beenden\r\n      if (this.resetValuesJob) {\r\n        this.resetValuesJob.cancel();\r\n        this.resetValuesJob = undefined;\r\n      }\r\n\r\n      if (this.checkStatesJob) {\r\n        this.checkStatesJob?.cancel();\r\n        this.checkStatesJob = undefined;\r\n      }\r\n\r\n      if (this.calculationJob) {\r\n        this.calculationJob.cancel();\r\n        this.calculationJob = undefined;\r\n      }\r\n\r\n      callback();\r\n    } catch (e) {\r\n      callback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called if a subscribed state changes\r\n   */\r\n  private onStateChange(\r\n    id: string,\r\n    state: ioBroker.State | null | undefined,\r\n  ): void {\r\n    if (state) {\r\n      // The state was changed\r\n      //this.log.debug(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n\r\n      // Read product and device key from string\r\n      const splitted = id.split(\".\");\r\n      const productKey = splitted[2];\r\n      const deviceKey = splitted[3];\r\n      const stateName1 = splitted[4];\r\n      const stateName2 = splitted[5];\r\n\r\n      if (state.val != undefined && state.val != null) {\r\n        switch (stateName1) {\r\n          case \"control\":\r\n            if (stateName2 == \"setOutputLimit\") {\r\n              setOutputLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"dischargeLimit\") {\r\n              setDischargeLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"chargeLimit\") {\r\n              setChargeLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"lowVoltageBlock\") {\r\n              if (this.config.useLowVoltageBlock) {\r\n                if (state.val == true) {\r\n                  // Low Voltage Block activated, stop power input\r\n                  setOutputLimit(this, productKey, deviceKey, 0);\r\n                }\r\n              }\r\n            }\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      } else {\r\n        // The state was deleted\r\n        this.log.debug(`state ${id} deleted`);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nif (require.main !== module) {\r\n  // Export the constructor in compact mode\r\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) =>\r\n    new ZendureSolarflow(options);\r\n} else {\r\n  // otherwise start the instance directly\r\n  (() => new ZendureSolarflow())();\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAOA,YAAuB;AACvB,yBAKO;AACP,wBAAqC;AAGrC,mBAAqC;AAErC,yBAIO;AAGA,MAAM,yBAAyB,MAAM,QAAQ;AAAA,EAC3C,YAAY,UAAyC,CAAC,GAAG;AAC9D,UAAM;AAAA,MACJ,GAAG;AAAA,MACH,MAAM;AAAA,IACR,CAAC;AAMH,SAAO,cAAkC;AACzC;AAAA,SAAO,aAAwC,CAAC;AAChD,SAAO,QAAqC;AAC5C,SAAO,WAA0C;AACjD,SAAO,YAA8B;AAErC,SAAO,aAAqC;AAE5C,SAAO,iBAAkC;AACzC,SAAO,iBAAkC;AACzC,SAAO,iBAAkC;AAfvC,SAAK,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AACxC,SAAK,GAAG,eAAe,KAAK,cAAc,KAAK,IAAI,CAAC;AACpD,SAAK,GAAG,UAAU,KAAK,SAAS,KAAK,IAAI,CAAC;AAAA,EAC5C;AAAA;AAAA;AAAA;AAAA,EAiBA,MAAc,UAAyB;AApDzC;AAsDI,QAAI,KAAK,OAAO,UAAU,KAAK,OAAO,UAAU,MAAM;AACpD,WAAK,QAAQ;AAAA,IACf,OAAO;AACL,WAAK,QAAQ;AAAA,IACf;AAGA,QAAI,KAAK,OAAO,YAAY,KAAK,OAAO,UAAU;AAChD,yCAAM,IAAI,MAAV,mBACI,KAAK,CAAC,iBAAyB;AAC/B,aAAK,cAAc;AAEnB,aAAK,YAAY;AACjB,aAAK,YAAY,oBAAI,KAAK;AAG1B,6CAAc,IAAI,EACf,KAAK,CAAC,WAAsC;AAC3C,cAAI,QAAQ;AAEV,iBAAK,aAAa;AAClB,sDAAkB,IAAI;AAGtB,kEAA8B,IAAI;AAClC,wDAAoB,IAAI;AACxB,wDAAoB,IAAI;AAAA,UAC1B;AAAA,QACF,CAAC,EACA,MAAM,MAAM;AAnFzB,cAAAA;AAoFc,eAAK,YAAY;AACjB,WAAAA,MAAA,KAAK,QAAL,gBAAAA,IAAU,MAAM;AAAA,QAClB,CAAC;AAAA,MACL,GACC,MAAM,CAAC,UAAU;AAChB,aAAK,YAAY;AACjB,aAAK,IAAI;AAAA,UACP,4DACE,MAAM,SAAS;AAAA,QACnB;AAAA,MACF;AAAA,IACJ,OAAO;AACL,WAAK,YAAY;AACjB,WAAK,IAAI,MAAM,0CAA0C;AAAA,IAE3D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,SAAS,UAA4B;AAzG/C;AA0GI,QAAI;AACF,UAAI,KAAK,UAAU;AACjB,aAAK,cAAc,KAAK,QAAQ;AAAA,MAClC;AAGA,UAAI,KAAK,gBAAgB;AACvB,aAAK,eAAe,OAAO;AAC3B,aAAK,iBAAiB;AAAA,MACxB;AAEA,UAAI,KAAK,gBAAgB;AACvB,mBAAK,mBAAL,mBAAqB;AACrB,aAAK,iBAAiB;AAAA,MACxB;AAEA,UAAI,KAAK,gBAAgB;AACvB,aAAK,eAAe,OAAO;AAC3B,aAAK,iBAAiB;AAAA,MACxB;AAEA,eAAS;AAAA,IACX,SAAS,GAAG;AACV,eAAS;AAAA,IACX;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,cACN,IACA,OACM;AACN,QAAI,OAAO;AAKT,YAAM,WAAW,GAAG,MAAM,GAAG;AAC7B,YAAM,aAAa,SAAS,CAAC;AAC7B,YAAM,YAAY,SAAS,CAAC;AAC5B,YAAM,aAAa,SAAS,CAAC;AAC7B,YAAM,aAAa,SAAS,CAAC;AAE7B,UAAI,MAAM,OAAO,UAAa,MAAM,OAAO,MAAM;AAC/C,gBAAQ,YAAY;AAAA,UAClB,KAAK;AACH,gBAAI,cAAc,kBAAkB;AAClC,qDAAe,MAAM,YAAY,WAAW,OAAO,MAAM,GAAG,CAAC;AAAA,YAC/D,WAAW,cAAc,kBAAkB;AACzC,wDAAkB,MAAM,YAAY,WAAW,OAAO,MAAM,GAAG,CAAC;AAAA,YAClE,WAAW,cAAc,eAAe;AACtC,qDAAe,MAAM,YAAY,WAAW,OAAO,MAAM,GAAG,CAAC;AAAA,YAC/D,WAAW,cAAc,mBAAmB;AAC1C,kBAAI,KAAK,OAAO,oBAAoB;AAClC,oBAAI,MAAM,OAAO,MAAM;AAErB,yDAAe,MAAM,YAAY,WAAW,CAAC;AAAA,gBAC/C;AAAA,cACF;AAAA,YACF;AACA;AAAA,UACF;AACE;AAAA,QACJ;AAAA,MACF,OAAO;AAEL,aAAK,IAAI,MAAM,SAAS,EAAE,UAAU;AAAA,MACtC;AAAA,IACF;AAAA,EACF;AACF;AAEA,IAAI,QAAQ,SAAS,QAAQ;AAE3B,SAAO,UAAU,CAAC,YAChB,IAAI,iBAAiB,OAAO;AAChC,OAAO;AAEL,GAAC,MAAM,IAAI,iBAAiB,GAAG;AACjC;",
  "names": ["_a"]
}
