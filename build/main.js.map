{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/indent */\r\n/*\r\n * Created with @iobroker/create-adapter v2.5.0\r\n */\r\n\r\n// The adapter-core module gives you access to the core ioBroker functions\r\n// you need to create an adapter\r\nimport * as utils from \"@iobroker/adapter-core\";\r\nimport {\r\n  connectMqttClient,\r\n  setAutoRecover,\r\n  setBuzzerSwitch,\r\n  setChargeLimit,\r\n  setDischargeLimit,\r\n  setOutputLimit,\r\n  setPassMode,\r\n} from \"./services/mqttService\";\r\nimport { getDeviceList, login } from \"./services/webService\";\r\nimport { ISolarFlowDeviceDetails } from \"./models/ISolarFlowDeviceDetails\";\r\nimport { ISolarFlowPaths } from \"./models/ISolarFlowPaths\";\r\nimport { pathsEu, pathsGlobal } from \"./constants/paths\";\r\nimport { Job } from \"node-schedule\";\r\nimport { MqttClient } from \"mqtt\";\r\nimport {\r\n  checkDevicesServer,\r\n  updateSolarFlowState,\r\n} from \"./services/adapterService\";\r\nimport { createSolarFlowStates } from \"./helpers/createSolarFlowStates\";\r\nimport { createDeveloperAccount } from \"./services/fallbackWebService\";\r\nimport { ISolarFlowDevRegisterData } from \"./models/ISolarflowDevRegisterResponse\";\r\nimport { connectFallbackMqttClient } from \"./services/fallbackMqttService\";\r\n\r\nexport class ZendureSolarflow extends utils.Adapter {\r\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n    super({\r\n      ...options,\r\n      name: \"zendure-solarflow\",\r\n    });\r\n    this.on(\"ready\", this.onReady.bind(this));\r\n    this.on(\"stateChange\", this.onStateChange.bind(this));\r\n    this.on(\"unload\", this.onUnload.bind(this));\r\n  }\r\n\r\n  public accessToken: string | undefined = undefined; // Access Token for Zendure Rest API\r\n  public deviceList: ISolarFlowDeviceDetails[] = [];\r\n  public paths: ISolarFlowPaths | undefined = undefined;\r\n\r\n  public lastLogin: Date | undefined = undefined;\r\n\r\n  public mqttClient: MqttClient | undefined = undefined;\r\n\r\n  public resetValuesJob: Job | undefined = undefined;\r\n  public checkStatesJob: Job | undefined = undefined;\r\n  public calculationJob: Job | undefined = undefined;\r\n  public refreshAccessTokenInterval: ioBroker.Interval | undefined = undefined;\r\n\r\n  public createdSnNumberSolarflowStates: string[] = [];\r\n\r\n  /**\r\n   * Is called when databases are connected and adapter received configuration.\r\n   */\r\n  private async onReady(): Promise<void> {\r\n    await this.extendObjectAsync(\"info\", {\r\n      type: \"channel\",\r\n      common: {\r\n        name: \"Information\",\r\n      },\r\n      native: {},\r\n    });\r\n\r\n    await this.extendObjectAsync(`info.connection`, {\r\n      type: \"state\",\r\n      common: {\r\n        name: {\r\n          de: \"Mit Zendure Cloud verbunden\",\r\n          en: \"Connected to Zendure cloud\",\r\n        },\r\n        type: \"boolean\",\r\n        desc: \"connection\",\r\n        role: \"indicator.connected\",\r\n        read: true,\r\n        write: false,\r\n      },\r\n      native: {},\r\n    });\r\n\r\n    // Select paths by config value\r\n    if (this.config.server && this.config.server == \"eu\") {\r\n      this.paths = pathsEu;\r\n    } else {\r\n      this.paths = pathsGlobal;\r\n    }\r\n\r\n    this.log.debug(\"[onReady] Using server \" + this.config.server);\r\n\r\n    if (this.config.useFallbackService && this.config.snNumber) {\r\n      // Use Fallback service. Using the developer version of the MQTT and Webservice from zendure\r\n      createDeveloperAccount(this).then((data: ISolarFlowDevRegisterData) => {\r\n        //console.log(data);\r\n        if (data.appKey && data.mqttUrl && data.port && data.secret) {\r\n          connectFallbackMqttClient(\r\n            this,\r\n            data.appKey,\r\n            data.secret,\r\n            data.mqttUrl,\r\n            data.port,\r\n          );\r\n        }\r\n      });\r\n    } else if (\r\n      !this.config.useFallbackService &&\r\n      this.config.userName &&\r\n      this.config.password\r\n    ) {\r\n      // App mode: If Username and Password is provided, try to login and get the access token.\r\n      login(this)\r\n        ?.then((_accessToken: string) => {\r\n          this.accessToken = _accessToken;\r\n\r\n          this.setState(\"info.connection\", true, true);\r\n          this.lastLogin = new Date();\r\n\r\n          // Try to get the device list\r\n          getDeviceList(this)\r\n            .then(async (result: ISolarFlowDeviceDetails[]) => {\r\n              if (result) {\r\n                // Device List found. Save in the adapter properties and connect to MQTT\r\n\r\n                // Filtering to SolarFlow devices\r\n                this.deviceList = result.filter((device) =>\r\n                  device.productName.toLowerCase().includes(\"solarflow\"),\r\n                );\r\n\r\n                await checkDevicesServer(this);\r\n\r\n                this.log.info(\r\n                  `[onReady] Found ${this.deviceList.length} SolarFlow device(s).`,\r\n                );\r\n\r\n                await this.deviceList.forEach(\r\n                  async (device: ISolarFlowDeviceDetails) => {\r\n                    // States erstellen\r\n                    await createSolarFlowStates(\r\n                      this,\r\n                      device.productKey,\r\n                      device.deviceKey,\r\n                    );\r\n\r\n                    await updateSolarFlowState(\r\n                      this,\r\n                      device.productKey,\r\n                      device.deviceKey,\r\n                      \"registeredServer\",\r\n                      this.config.server,\r\n                    );\r\n                  },\r\n                );\r\n\r\n                connectMqttClient(this);\r\n              }\r\n            })\r\n            .catch(() => {\r\n              this.setState(\"info.connection\", false, true);\r\n              this.log?.error(\"[onReady] Retrieving device failed!\");\r\n            });\r\n        })\r\n        .catch((error) => {\r\n          this.setState(\"info.connection\", false, true);\r\n          this.log.error(\r\n            \"[onReady] Logon error at Zendure cloud service! Error: \" +\r\n              error.toString(),\r\n          );\r\n        });\r\n    } else {\r\n      this.setState(\"info.connection\", false, true);\r\n      this.log.error(\"[onReady] No Login Information provided!\");\r\n      //this.stop?.();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n   */\r\n  private onUnload(callback: () => void): void {\r\n    try {\r\n      if (this.refreshAccessTokenInterval) {\r\n        this.clearInterval(this.refreshAccessTokenInterval);\r\n      }\r\n\r\n      this.mqttClient?.end();\r\n\r\n      this.setState(\"info.connection\", false, true);\r\n\r\n      // Scheduler beenden\r\n      if (this.resetValuesJob) {\r\n        this.resetValuesJob.cancel();\r\n        this.resetValuesJob = undefined;\r\n      }\r\n\r\n      if (this.checkStatesJob) {\r\n        this.checkStatesJob?.cancel();\r\n        this.checkStatesJob = undefined;\r\n      }\r\n\r\n      if (this.calculationJob) {\r\n        this.calculationJob.cancel();\r\n        this.calculationJob = undefined;\r\n      }\r\n\r\n      callback();\r\n    } catch (e) {\r\n      callback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Is called if a subscribed state changes\r\n   */\r\n  private onStateChange(\r\n    id: string,\r\n    state: ioBroker.State | null | undefined,\r\n  ): void {\r\n    if (state) {\r\n      // The state was changed\r\n      //this.log.debug(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n\r\n      // Read product and device key from string\r\n      const splitted = id.split(\".\");\r\n      const productKey = splitted[2];\r\n      const deviceKey = splitted[3];\r\n      const stateName1 = splitted[4];\r\n      const stateName2 = splitted[5];\r\n\r\n      if (this.config.useFallbackService && stateName1 == \"control\") {\r\n        this.log.warn(\r\n          `[onStateChange] Using Fallback server, control of Solarflow device is not possible!`,\r\n        );\r\n      }\r\n      // !!! Only stateChanges with ack==false are allowed to be processed.\r\n      else if (state.val != undefined && state.val != null && !state.ack) {\r\n        switch (stateName1) {\r\n          case \"control\":\r\n            if (stateName2 == \"setOutputLimit\") {\r\n              setOutputLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"dischargeLimit\") {\r\n              setDischargeLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"chargeLimit\") {\r\n              setChargeLimit(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"passMode\") {\r\n              setPassMode(this, productKey, deviceKey, Number(state.val));\r\n            } else if (stateName2 == \"autoRecover\") {\r\n              setAutoRecover(\r\n                this,\r\n                productKey,\r\n                deviceKey,\r\n                state.val ? true : false,\r\n              );\r\n            } else if (stateName2 == \"buzzerSwitch\") {\r\n              setBuzzerSwitch(\r\n                this,\r\n                productKey,\r\n                deviceKey,\r\n                state.val ? true : false,\r\n              );\r\n            }\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      } else {\r\n        // The state was deleted\r\n        //this.log.debug(`state ${id} deleted`);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nif (require.main !== module) {\r\n  // Export the constructor in compact mode\r\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) =>\r\n    new ZendureSolarflow(options);\r\n} else {\r\n  // otherwise start the instance directly\r\n  (() => new ZendureSolarflow())();\r\n}\r\n"],
  "mappings": "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",
  "names": ["_a"]
}
